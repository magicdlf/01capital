<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Secret文件管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="../js/code-manager.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            font-weight: 600;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .user-data-preview {
            max-height: 600px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .preview-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview-section h4 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-preview {
            background: #28a745;
            border-color: #28a745;
        }
        .btn-preview:hover {
            background: #218838;
            border-color: #1e7e34;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Shared Secret文件管理工具</h1>
        
        <!-- 1. 密码修改处理流程 - 放在最上面 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>密码修改处理流程</h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>管理员在下方工具中输入用户名，系统自动匹配预设的8位编码</li>
                    <li>管理员将生成的邀请链接发送给用户</li>
                    <li>用户点击链接进入密码重置页面</li>
                    <li>用户输入新密码并生成Shared Secret</li>
                    <li>用户将Shared Secret告知管理员</li>
                    <li>管理员手动更新用户数据文件中的Shared Secret</li>
                </ol>
            </div>
        </div>
        
        <!-- 2. Shared Secret生成工具和密码重置邀请链接生成 - 并列排放 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Shared Secret生成工具</h5>
                    </div>
                    <div class="card-body">
                        <form id="generateHashForm">
                            <div class="mb-3">
                                <label for="genUsername" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="genUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="genPassword" class="form-label">密码</label>
                                <input type="password" class="form-control" id="genPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="generatedHash" class="form-label">生成的Shared Secret</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="generatedHash" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyHashButton">复制</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" id="generateHashButton">生成Shared Secret</button>
                        </form>

                        <hr class="my-4">

                        <!-- 逆序Shared Secret恢复工具 -->
                        <div>
                            <h6 class="mb-3">逆序Shared Secret恢复</h6>
                            <form id="reverseHashForm">
                                <div class="mb-3">
                                    <label for="reversedSecretInput" class="form-label">从重置页面复制的Shared Secret（逆序）</label>
                                    <input type="text" class="form-control" id="reversedSecretInput" placeholder="粘贴逆序的Shared Secret">
                                </div>
                                <div class="mb-3">
                                    <label for="recoveredHash" class="form-label">恢复后的原始Shared Secret</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="recoveredHash" readonly>
                                        <button class="btn btn-outline-secondary" type="button" id="copyRecoveredButton">复制</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" id="reverseHashButton">恢复原始顺序</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>密码重置邀请链接生成</h5>
                    </div>
                    <div class="card-body">
                        <form id="inviteLinkForm">
                            <div class="mb-3">
                                <label for="inviteUsername" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="inviteUsername" required>
                                <div class="form-text">输入用户名，系统将自动匹配预设的8位编码</div>
                            </div>
                            <div class="mb-3" id="codeInfo" style="display: none;">
                                <label for="foundCode" class="form-label">编码信息</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="foundCode" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyCodeButton">复制编码</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="inviteLink" class="form-label">邀请链接</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="inviteLink" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyInviteButton">复制链接</button>
                                </div>
                                <div class="form-text">将此链接发送给用户，用户点击后可直接进入密码重置页面</div>
                            </div>
                            <button type="button" class="btn btn-primary" id="generateInviteButton">生成邀请链接</button>
                        </form>
                        
                        <!-- 结果显示区域 -->
                        <div id="result" class="result mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. 用户数据预览（包含用户数据和完整预览） -->
        <div class="card">
            <div class="card-header">
                <h5>用户数据预览</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 左侧：输入表单 -->
                    <div class="col-md-4">
                        <form id="previewForm">
                            <div class="mb-3">
                                <label for="previewUsername" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="previewUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="previewHashFile" class="form-label">Shared Secret文件名</label>
                                <input type="text" class="form-control" id="previewHashFile" required>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="previewUserData">预览用户数据</button>
                                <button type="button" class="btn btn-success" id="previewFullView">完整预览（投资组合概览+收益曲线+明细）</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 右侧：用户数据预览 -->
                    <div class="col-md-8">
                        <div id="userDataPreview" class="user-data-preview">
                            <p class="text-muted">请输入用户名和Shared Secret文件名来预览用户数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 完整预览区域 -->
        <div id="fullPreviewArea" style="display: none;" class="mt-4">
            <div class="preview-section">
                <h4>投资组合概览</h4>
                <div id="portfolioOverview"></div>
            </div>
            
            <div class="preview-section">
                <h4>收益曲线</h4>
                <div class="chart-container">
                    <canvas id="returnChart"></canvas>
                </div>
            </div>
            
            <div class="preview-section">
                <h4>投资组合明细</h4>
                <div id="portfolioDetails"></div>
            </div>
            
            <div class="preview-section">
                <h4>投资明细记录</h4>
                <p class="text-muted small mb-3">注：单位净值仅展示4位小数</p>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table" id="investmentDetailTable">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
                            <tr>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">投资者</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">交易日期</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">产品名称</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">操作类型</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">币种</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">交易金额</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">份额变化</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">累计份额</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">单位净值</th>
                            </tr>
                        </thead>
                        <tbody id="investmentDetailTableBody">
                            <!-- 数据将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 生成Hash值
        async function generateHash() {
            const username = document.getElementById('genUsername').value;
            const password = document.getElementById('genPassword').value;
            const hashInput = document.getElementById('generatedHash');
            
            if (!username || !password) {
                showResult('请输入用户名和密码', 'error');
                return;
            }
            
            try {
                const combined = username.toLowerCase() + ':' + password;
                const encoder = new TextEncoder();
                const data = encoder.encode(combined);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                
                const shortHashArray = hashArray.slice(0, 16);
                const base64 = btoa(String.fromCharCode.apply(null, shortHashArray))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
                
                const hashValue = base64;
                hashInput.value = hashValue;
                
                showResult(`Shared Secret生成成功：${hashValue}`, 'success');
            } catch (error) {
                showResult('生成Shared Secret时发生错误：' + error.message, 'error');
            }
        }
        
        // 复制Shared Secret
        function copyHashToClipboard() {
            const hashInput = document.getElementById('generatedHash');
            const copyButton = document.getElementById('copyHashButton');
            
            if (!hashInput.value) {
                showResult('请先生成Shared Secret', 'error');
                return;
            }
            
            hashInput.select();
            hashInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                copyButton.textContent = '已复制';
                copyButton.classList.remove('btn-outline-secondary');
                copyButton.classList.add('btn-success');
                
                setTimeout(() => {
                    copyButton.textContent = '复制';
                    copyButton.classList.remove('btn-success');
                    copyButton.classList.add('btn-outline-secondary');
                }, 2000);
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(hashInput.value).then(() => {
                        copyButton.textContent = '已复制';
                        copyButton.classList.remove('btn-outline-secondary');
                        copyButton.classList.add('btn-success');
                        
                        setTimeout(() => {
                            copyButton.textContent = '复制';
                            copyButton.classList.remove('btn-success');
                            copyButton.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(() => {
                        showResult('复制失败，请手动复制', 'error');
                    });
                } else {
                    showResult('复制失败，请手动复制', 'error');
                }
            }
        }
        
        // 逆序字符串（用于恢复Shared Secret）
        function reverseString(input) {
            if (typeof input !== 'string') return '';
            return input.split('').reverse().join('');
        }

        // 从逆序的 Shared Secret 恢复原始值
        function recoverOriginalSecret() {
            const reversedInput = document.getElementById('reversedSecretInput');
            const recoveredOutput = document.getElementById('recoveredHash');
            const value = (reversedInput.value || '').trim();
            if (!value) {
                showResult('请粘贴逆序的Shared Secret', 'error');
                return;
            }
            const recovered = reverseString(value);
            recoveredOutput.value = recovered;
            showResult('已恢复原始Shared Secret', 'success');
        }

        // 复制恢复后的 Shared Secret
        function copyRecoveredSecret() {
            const output = document.getElementById('recoveredHash');
            const copyButton = document.getElementById('copyRecoveredButton');
            if (!output.value) {
                showResult('没有可复制的内容', 'error');
                return;
            }
            output.select();
            output.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                copyButton.textContent = '已复制';
                copyButton.classList.remove('btn-outline-secondary');
                copyButton.classList.add('btn-success');
                setTimeout(() => {
                    copyButton.textContent = '复制';
                    copyButton.classList.remove('btn-success');
                    copyButton.classList.add('btn-outline-secondary');
                }, 2000);
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(output.value).then(() => {
                        copyButton.textContent = '已复制';
                        copyButton.classList.remove('btn-outline-secondary');
                        copyButton.classList.add('btn-success');
                        setTimeout(() => {
                            copyButton.textContent = '复制';
                            copyButton.classList.remove('btn-success');
                            copyButton.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(() => {
                        showResult('复制失败，请手动复制', 'error');
                    });
                } else {
                    showResult('复制失败，请手动复制', 'error');
                }
            }
        }
        
        // 预览用户数据
        async function previewUserData() {
            const username = document.getElementById('previewUsername').value;
            let currentHashFile = document.getElementById('previewHashFile').value;
            const previewDiv = document.getElementById('userDataPreview');
            
            if (!username || !currentHashFile) {
                previewDiv.innerHTML = '<p class="text-danger">请输入用户名和Hash文件名</p>';
                return;
            }
            
            // 自动添加.json扩展名（如果没有的话）
            if (!currentHashFile.endsWith('.json')) {
                currentHashFile += '.json';
            }
            
            try {
                const response = await fetch(`https://data.01capital.info/arbcus/${currentHashFile}?t=${new Date().getTime()}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    previewDiv.innerHTML = `
                        <h6>用户信息</h6>
                        <p><strong>用户名：</strong>${userData.username}</p>
                        <p><strong>创建时间：</strong>${userData.created_at}</p>
                        ${userData.password_changed_at ? `<p><strong>密码修改时间：</strong>${userData.password_changed_at}</p>` : ''}
                        <p><strong>投资数据：</strong></p>
                        <ul>
                            <li>Alpha-Bridge: ${userData.investments.balanced ? userData.investments.balanced.length : 0} 条记录</li>
                            <li>Stable-Harbor-USDT: ${userData.investments.arbitrage ? userData.investments.arbitrage.length : 0} 条记录</li>
                            <li>Stable-Harbor-USDT 2.0: ${userData.investments.arbitrage2 ? userData.investments.arbitrage2.length : 0} 条记录</li>
                            <li>Stable-Harbor-BTC: ${
                                userData.investments.arbitrage_coin
                                    ? userData.investments.arbitrage_coin.filter(item => item.coin === 'BTC').length
                                    : 0
                            } 条记录</li>
                            <li>Stable-Harbor-ETH: ${
                                userData.investments.arbitrage_eth
                                    ? userData.investments.arbitrage_eth.length
                                    : 0
                            } 条记录</li>
                        </ul>
                        <h6>最新投资数据预览：</h6>
                        <pre style="font-size: 12px; max-height: 200px; overflow-y: auto;">${JSON.stringify(userData, null, 2)}</pre>
                    `;
                } else {
                    previewDiv.innerHTML = `<p class="text-danger">无法加载用户数据，请检查Hash文件名是否正确</p><p class="text-muted">尝试的文件名：${currentHashFile}</p>`;
                }
            } catch (error) {
                previewDiv.innerHTML = '<p class="text-danger">加载用户数据时发生错误</p>';
            }
        }
        
        // 完整预览功能
        async function previewFullView() {
            const username = document.getElementById('previewUsername').value;
            let currentHashFile = document.getElementById('previewHashFile').value;
            
            if (!username || !currentHashFile) {
                showResult('请输入用户名和Hash文件名', 'error');
                return;
            }
            
            // 自动添加.json扩展名（如果没有的话）
            if (!currentHashFile.endsWith('.json')) {
                currentHashFile += '.json';
            }
            
            try {
                const response = await fetch(`https://data.01capital.info/arbcus/${currentHashFile}?t=${new Date().getTime()}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    
                    // 显示完整预览区域
                    document.getElementById('fullPreviewArea').style.display = 'block';
                    
                    // 生成投资组合概览
                    generatePortfolioOverview(userData, username);
                    
                    // 生成收益曲线
                    generateReturnChart(userData);
                    
                    // 生成投资组合明细
                    generatePortfolioDetails(userData);
                    
                    // 加载并显示投资明细记录
                    loadAndDisplayInvestmentDetails(username, userData);
                    
                    showResult('完整预览已生成', 'success');
                } else {
                    showResult('无法加载用户数据，请检查Hash文件名是否正确', 'error');
                }
            } catch (error) {
                showResult('加载用户数据时发生错误: ' + error.message, 'error');
            }
        }
        
        // 生成投资组合概览
        function generatePortfolioOverview(userData, username) {
            const overviewDiv = document.getElementById('portfolioOverview');
            
            // 获取最新数据
            const balancedLatestData = getLatestData(userData.investments.balanced);
            const arbitrageLatestData = getLatestData(userData.investments.arbitrage);
            const arbitrage2LatestData = getLatestData(userData.investments.arbitrage2);
            const arbitrageCoinData = userData.investments.arbitrage_coin || [];
            const arbitrageEthData = userData.investments.arbitrage_eth || [];
            const arbitrageCoinBtcLatestData = getLatestData(arbitrageCoinData.filter(item => item.coin === 'BTC'));
            // Stable-Harbor-ETH 只使用 investments.arbitrage_eth
            const arbitrageCoinEthLatestData = getLatestData(arbitrageEthData);
            // Deep-Growth：用户JSON里用 investments.growth 存储
            const growthLatestData = getLatestData(userData.investments.growth);
            
            // 按币种分组计算总资产和收益
            const assetsByCoin = {};
            
            // Alpha-Bridge：即使本金为 0 也统计资产和收益，但不计入当前持仓数量
            if (balancedLatestData) {
                const coin = balancedLatestData.coin;
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += balancedLatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += balancedLatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += balancedLatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += balancedLatestData.net_pnl;
                if (balancedLatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }
            
            // Stable-Harbor-USDT：同样逻辑
            if (arbitrageLatestData) {
                const coin = arbitrageLatestData.coin;
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += arbitrageLatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += arbitrageLatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += arbitrageLatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += arbitrageLatestData.net_pnl;
                if (arbitrageLatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }
            
            // Stable-Harbor-USDT 2.0：同样逻辑
            if (arbitrage2LatestData) {
                const coin = arbitrage2LatestData.coin;
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += arbitrage2LatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += arbitrage2LatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += arbitrage2LatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += arbitrage2LatestData.net_pnl;
                if (arbitrage2LatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }
            
            // Stable-Harbor-BTC：同样逻辑
            if (arbitrageCoinBtcLatestData) {
                const coin = arbitrageCoinBtcLatestData.coin;
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += arbitrageCoinBtcLatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += arbitrageCoinBtcLatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += arbitrageCoinBtcLatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += arbitrageCoinBtcLatestData.net_pnl;
                if (arbitrageCoinBtcLatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }
            
            // Stable-Harbor-ETH：同样逻辑（使用 arbitrage_eth）
            if (arbitrageCoinEthLatestData) {
                const coin = arbitrageCoinEthLatestData.coin;
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += arbitrageCoinEthLatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += arbitrageCoinEthLatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += arbitrageCoinEthLatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += arbitrageCoinEthLatestData.net_pnl;
                if (arbitrageCoinEthLatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }

            // Deep-Growth：同样逻辑（用户JSON里是 investments.growth）
            if (growthLatestData) {
                const coin = growthLatestData.coin || 'USDT';
                if (!assetsByCoin[coin]) {
                    assetsByCoin[coin] = {
                        totalNetNav: 0,
                        totalNetPnl: 0,
                        realizedPnl: 0,
                        unrealizedPnl: 0,
                        holdingCount: 0
                    };
                }
                assetsByCoin[coin].totalNetNav += growthLatestData.net_nav;
                assetsByCoin[coin].totalNetPnl += growthLatestData.net_pnl;
                assetsByCoin[coin].realizedPnl += growthLatestData.realized_pnl;
                assetsByCoin[coin].unrealizedPnl += growthLatestData.net_pnl;
                if (growthLatestData.principal > 0) {
                    assetsByCoin[coin].holdingCount++;
                }
            }
            
            // 生成概览HTML
            let overviewHtml = '';
            if (Object.keys(assetsByCoin).length > 0) {
                const totalHoldingCount = Object.values(assetsByCoin).reduce((sum, data) => sum + data.holdingCount, 0);
                // 币种展示顺序：总资产 ≥ 1 的在前，总资产 < 1 的在后
                const sortedAssetsEntries = Object.entries(assetsByCoin).sort(([, a], [, b]) => {
                    const aSmall = a.totalNetNav < 1;
                    const bSmall = b.totalNetNav < 1;
                    if (aSmall === bSmall) return 0;
                    return aSmall ? 1 : -1; // 总资产 < 1 的放后面
                });
                
                overviewHtml = `
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td class="fw-bold">总资产</td>
                                    <td>${sortedAssetsEntries.map(([coin, data]) => 
                                        `${coin} ${data.totalNetNav.toLocaleString('zh-CN', {minimumFractionDigits: coin === 'BTC' ? 4 : 2, maximumFractionDigits: coin === 'BTC' ? 4 : 2})}`
                                    ).join('&emsp;｜&emsp;')}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">累计收益</td>
                                    <td class="text-success">${sortedAssetsEntries.map(([coin, data]) => {
                                        const total = data.realizedPnl + data.unrealizedPnl;
                                        return `+${coin} ${total.toLocaleString('zh-CN', {minimumFractionDigits: coin === 'BTC' ? 4 : 2, maximumFractionDigits: coin === 'BTC' ? 4 : 2})}`;
                                    }).join('&emsp;｜&emsp;')}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold" style="white-space:nowrap;">已实现收益</td>
                                    <td>${sortedAssetsEntries.map(([coin, data]) => 
                                        `${coin} ${data.realizedPnl.toLocaleString('zh-CN', {minimumFractionDigits: coin === 'BTC' ? 4 : 2, maximumFractionDigits: coin === 'BTC' ? 4 : 2})}`
                                    ).join('&emsp;｜&emsp;')}
                                    ${getDividendInfo(username)}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold" style="white-space:nowrap;">未实现收益</td>
                                    <td>${sortedAssetsEntries.map(([coin, data]) => 
                                        `${coin} ${data.unrealizedPnl.toLocaleString('zh-CN', {minimumFractionDigits: coin === 'BTC' ? 4 : 2, maximumFractionDigits: coin === 'BTC' ? 4 : 2})}`
                                    ).join('&emsp;｜&emsp;')}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">当前持仓</td>
                                    <td>${totalHoldingCount}个组合</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                overviewHtml = `
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td class="fw-bold">总资产</td>
                                    <td>0.00</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">累计收益</td>
                                    <td>0.00 (0.00%)</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">已实现收益</td>
                                    <td>0.00</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">未实现收益</td>
                                    <td>0.00</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">当前持仓</td>
                                    <td>0个组合</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            overviewDiv.innerHTML = overviewHtml;
        }
        
        // 生成收益曲线
        function generateReturnChart(userData) {
            const ctx = document.getElementById('returnChart');
            if (!ctx) return;
            
            // 销毁现有图表
            if (window.returnChartInstance) {
                window.returnChartInstance.destroy();
            }
            
            // 工具函数：只保留每月最后一天的数据点
            function filterToMonthEnd(data) {
                const grouped = {};
                
                // 按月份分组，每个月份保留最新的数据点
                data.forEach(item => {
                    const date = new Date(item.x);
                    const ym = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const isLastDayOfMonth = date.getDate() === new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                    
                    // 如果该月还没有数据，或者当前数据是月末，或者当前数据比已有数据更新，则保留
                    if (!grouped[ym] || isLastDayOfMonth || date > new Date(grouped[ym].originalDate)) {
                        grouped[ym] = {
                            x: ym,
                            y: item.y,
                            isMonthEnd: isLastDayOfMonth,
                            originalDate: item.x // 保存原始日期用于比较
                        };
                    }
                });
                
                return Object.values(grouped).sort((a, b) => a.x.localeCompare(b.x));
            }
            
            // 准备数据
            // 筛选本金>1的记录（已赎回的用户不显示后续数据）
            const balancedReturns = filterToMonthEnd(
                (userData?.investments?.balanced || [])
                    .filter(record => (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );
            
            const arbitrageReturns = filterToMonthEnd(
                (userData?.investments?.arbitrage || [])
                    .filter(record => (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );
            
            const arbitrage2Returns = filterToMonthEnd(
                (userData?.investments?.arbitrage2 || [])
                    .filter(record => (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );
            
            const arbitrageCoinBtcReturns = filterToMonthEnd(
                (userData?.investments?.arbitrage_coin || [])
                    .filter(record => record.coin === 'BTC' && (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );
            
            // ETH 组合：只使用 investments.arbitrage_eth
            const arbitrageCoinEthReturns = filterToMonthEnd(
                (userData?.investments?.arbitrage_eth || [])
                    .filter(record => (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );

            const growthReturns = filterToMonthEnd(
                (userData?.investments?.growth || [])
                    .filter(record => (record.principal || 0) > 1)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(record => ({
                        x: formatDateToYMD(record.date),
                        y: record.total_return * 100
                    }))
            );
            
            // 准备图表数据
            const datasets = [];
            if (balancedReturns.length > 0) {
                const lastPointIsMonthEnd = balancedReturns[balancedReturns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Alpha-Bridge',
                    data: balancedReturns,
                    borderColor: '#1a2530',
                    backgroundColor: 'rgba(26,37,48,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === balancedReturns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }
            if (arbitrageReturns.length > 0) {
                const lastPointIsMonthEnd = arbitrageReturns[arbitrageReturns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Stable-Harbor-USDT',
                    data: arbitrageReturns,
                    borderColor: '#4a90e2',
                    backgroundColor: 'rgba(74,144,226,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === arbitrageReturns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }
            if (arbitrage2Returns.length > 0) {
                const lastPointIsMonthEnd = arbitrage2Returns[arbitrage2Returns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Stable-Harbor-USDT 2.0',
                    data: arbitrage2Returns,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52,152,219,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === arbitrage2Returns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }
            if (arbitrageCoinBtcReturns.length > 0) {
                const lastPointIsMonthEnd = arbitrageCoinBtcReturns[arbitrageCoinBtcReturns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Stable-Harbor-BTC',
                    data: arbitrageCoinBtcReturns,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231,76,60,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === arbitrageCoinBtcReturns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }
            if (arbitrageCoinEthReturns.length > 0) {
                const lastPointIsMonthEnd = arbitrageCoinEthReturns[arbitrageCoinEthReturns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Stable-Harbor-ETH',
                    data: arbitrageCoinEthReturns,
                    borderColor: '#8e44ad',
                    backgroundColor: 'rgba(142,68,173,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === arbitrageCoinEthReturns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }

            if (growthReturns.length > 0) {
                const lastPointIsMonthEnd = growthReturns[growthReturns.length - 1].isMonthEnd;
                datasets.push({
                    label: 'Deep-Growth',
                    data: growthReturns,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46,204,113,0.1)',
                    tension: 0.2,
                    fill: false,
                    segment: {
                        borderDash: ctx => {
                            if (ctx.p1DataIndex === growthReturns.length - 1 && !lastPointIsMonthEnd) {
                                return [5, 5];
                            }
                            return [];
                        }
                    }
                });
            }
            
            // 创建图表
            window.returnChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '累计收益率 (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成投资组合明细
        function generatePortfolioDetails(userData) {
            const detailsDiv = document.getElementById('portfolioDetails');
            
            // 筛选本金>1的记录（用于收益曲线和统计计算）
            const balancedFiltered = (userData.investments.balanced || []).filter(record => (record.principal || 0) > 1);
            const arbitrageFiltered = (userData.investments.arbitrage || []).filter(record => (record.principal || 0) > 1);
            const arbitrage2Filtered = (userData.investments.arbitrage2 || []).filter(record => (record.principal || 0) > 1);
            const arbitrageCoinData = userData.investments.arbitrage_coin || [];
            const arbitrageEthData = userData.investments.arbitrage_eth || [];
            const arbitrageCoinBtcFiltered = arbitrageCoinData.filter(item => item.coin === 'BTC' && (item.principal || 0) > 1);
            const arbitrageEthFiltered = arbitrageEthData.filter(record => (record.principal || 0) > 1);
            const growthFiltered = (userData.investments.growth || []).filter(record => (record.principal || 0) > 1);
            
            // 获取所有记录的最新数据（用于判断是否已赎回）
            const balancedAllLatestData = getLatestData(userData.investments.balanced || []);
            const arbitrageAllLatestData = getLatestData(userData.investments.arbitrage || []);
            const arbitrage2AllLatestData = getLatestData(userData.investments.arbitrage2 || []);
            const arbitrageCoinBtcAllLatestData = getLatestData(arbitrageCoinData.filter(item => item.coin === 'BTC'));
            const arbitrageEthAllLatestData = getLatestData(arbitrageEthData);
            const growthAllLatestData = getLatestData(userData.investments.growth || []);
            
            // 判断是否已赎回（最新记录本金<1）
            const isBalancedRedeemed = balancedAllLatestData && (balancedAllLatestData.principal || 0) < 1;
            const isArbitrageRedeemed = arbitrageAllLatestData && (arbitrageAllLatestData.principal || 0) < 1;
            const isArbitrage2Redeemed = arbitrage2AllLatestData && (arbitrage2AllLatestData.principal || 0) < 1;
            const isArbitrageCoinBtcRedeemed = arbitrageCoinBtcAllLatestData && (arbitrageCoinBtcAllLatestData.principal || 0) < 1;
            const isArbitrageEthRedeemed = arbitrageEthAllLatestData && (arbitrageEthAllLatestData.principal || 0) < 1;
            const isGrowthRedeemed = growthAllLatestData && (growthAllLatestData.principal || 0) < 1;
            
            // 获取用于显示的最新数据（如果已赎回，使用null；否则使用筛选后的数据）
            const balancedLatestData = isBalancedRedeemed ? null : getLatestData(balancedFiltered);
            const arbitrageLatestData = isArbitrageRedeemed ? null : getLatestData(arbitrageFiltered);
            const arbitrage2LatestData = isArbitrage2Redeemed ? null : getLatestData(arbitrage2Filtered);
            const arbitrageCoinBtcLatestData = isArbitrageCoinBtcRedeemed ? null : getLatestData(arbitrageCoinBtcFiltered);
            const arbitrageCoinEthLatestData = isArbitrageEthRedeemed ? null : getLatestData(arbitrageEthFiltered);
            const growthLatestData = isGrowthRedeemed ? null : getLatestData(growthFiltered);
            
            const balancedStats = calculateStats(balancedFiltered);
            const arbitrageStats = calculateStats(arbitrageFiltered);
            const arbitrage2Stats = calculateStats(arbitrage2Filtered);
            const arbitrageCoinBtcStats = calculateStats(arbitrageCoinBtcFiltered);
            const arbitrageCoinEthStats = calculateStats(arbitrageEthFiltered);
            const growthStats = calculateStats(growthFiltered);
            
            const detailsHtml = `
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
                            <tr>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">产品名称</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">币种</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">本金</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">当前价值</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">收益率</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">持仓天数</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">年化收益率</th>
                                <th style="background-color: #f8f9fa; position: sticky; top: 0;">数据日期</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Alpha-Bridge</td>
                                <td>${balancedAllLatestData ? balancedAllLatestData.coin : 'USDT'}</td>
                                <td>${isBalancedRedeemed ? '0.00' : (balancedLatestData ? balancedLatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: (balancedLatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (balancedLatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${isBalancedRedeemed ? '0.00' : (balancedLatestData ? balancedLatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: (balancedLatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (balancedLatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${balancedStats.returnRate ? balancedStats.returnRate + '%' : '0.00%'}</td>
                                <td>${balancedStats.holdingDays}</td>
                                <td>${balancedStats.annualizedReturn ? balancedStats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isBalancedRedeemed ? (balancedLatestData ? formatDateToYMD(balancedLatestData.date) : '-') : (balancedAllLatestData ? formatDateToYMD(balancedAllLatestData.date) : '-')}</td>
                            </tr>
                            <tr>
                                <td>Stable-Harbor-USDT</td>
                                <td>${arbitrageAllLatestData ? arbitrageAllLatestData.coin : 'USDT'}</td>
                                <td>${isArbitrageRedeemed ? '0.00' : (arbitrageLatestData ? arbitrageLatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: (arbitrageLatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (arbitrageLatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${isArbitrageRedeemed ? '0.00' : (arbitrageLatestData ? arbitrageLatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: (arbitrageLatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (arbitrageLatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${arbitrageStats.returnRate ? arbitrageStats.returnRate + '%' : '0.00%'}</td>
                                <td>${arbitrageStats.holdingDays}</td>
                                <td>${arbitrageStats.annualizedReturn ? arbitrageStats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isArbitrageRedeemed ? (arbitrageLatestData ? formatDateToYMD(arbitrageLatestData.date) : '-') : (arbitrageAllLatestData ? formatDateToYMD(arbitrageAllLatestData.date) : '-')}</td>
                            </tr>
                            <tr>
                                <td>Stable-Harbor-USDT 2.0</td>
                                <td>${arbitrage2AllLatestData ? arbitrage2AllLatestData.coin : 'USDT'}</td>
                                <td>${isArbitrage2Redeemed ? '0.00' : (arbitrage2LatestData ? arbitrage2LatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: (arbitrage2LatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (arbitrage2LatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${isArbitrage2Redeemed ? '0.00' : (arbitrage2LatestData ? arbitrage2LatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: (arbitrage2LatestData.coin === 'BTC') ? 4 : 2, maximumFractionDigits: (arbitrage2LatestData.coin === 'BTC') ? 4 : 2}) : '0.00')}</td>
                                <td>${arbitrage2Stats.returnRate ? arbitrage2Stats.returnRate + '%' : '0.00%'}</td>
                                <td>${arbitrage2Stats.holdingDays}</td>
                                <td>${arbitrage2Stats.annualizedReturn ? arbitrage2Stats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isArbitrage2Redeemed ? (arbitrage2LatestData ? formatDateToYMD(arbitrage2LatestData.date) : '-') : (arbitrage2AllLatestData ? formatDateToYMD(arbitrage2AllLatestData.date) : '-')}</td>
                            </tr>
                            <tr>
                                <td>Stable-Harbor-BTC</td>
                                <td>${arbitrageCoinBtcAllLatestData ? arbitrageCoinBtcAllLatestData.coin : 'BTC'}</td>
                                <td>${isArbitrageCoinBtcRedeemed ? '0.00' : (arbitrageCoinBtcLatestData ? arbitrageCoinBtcLatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4}) : '0.00')}</td>
                                <td>${isArbitrageCoinBtcRedeemed ? '0.00' : (arbitrageCoinBtcLatestData ? arbitrageCoinBtcLatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4}) : '0.00')}</td>
                                <td>${arbitrageCoinBtcStats.returnRate ? arbitrageCoinBtcStats.returnRate + '%' : '0.00%'}</td>
                                <td>${arbitrageCoinBtcStats.holdingDays}</td>
                                <td>${arbitrageCoinBtcStats.annualizedReturn ? arbitrageCoinBtcStats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isArbitrageCoinBtcRedeemed ? (arbitrageCoinBtcLatestData ? formatDateToYMD(arbitrageCoinBtcLatestData.date) : '-') : (arbitrageCoinBtcAllLatestData ? formatDateToYMD(arbitrageCoinBtcAllLatestData.date) : '-')}</td>
                            </tr>
                            <tr>
                                <td>Stable-Harbor-ETH</td>
                                <td>${arbitrageEthAllLatestData ? arbitrageEthAllLatestData.coin : 'ETH'}</td>
                                <td>${isArbitrageEthRedeemed ? '0.00' : (arbitrageCoinEthLatestData ? arbitrageCoinEthLatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4}) : '0.00')}</td>
                                <td>${isArbitrageEthRedeemed ? '0.00' : (arbitrageCoinEthLatestData ? arbitrageCoinEthLatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: 4, maximumFractionDigits: 4}) : '0.00')}</td>
                                <td>${arbitrageCoinEthStats.returnRate ? arbitrageCoinEthStats.returnRate + '%' : '0.00%'}</td>
                                <td>${arbitrageCoinEthStats.holdingDays}</td>
                                <td>${arbitrageCoinEthStats.annualizedReturn ? arbitrageCoinEthStats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isArbitrageEthRedeemed ? (arbitrageCoinEthLatestData ? formatDateToYMD(arbitrageCoinEthLatestData.date) : '-') : (arbitrageEthAllLatestData ? formatDateToYMD(arbitrageEthAllLatestData.date) : '-')}</td>
                            </tr>
                            <tr>
                                <td>Deep-Growth</td>
                                <td>${growthAllLatestData ? (growthAllLatestData.coin || 'USDT') : 'USDT'}</td>
                                <td>${isGrowthRedeemed ? '0.00' : (growthLatestData ? growthLatestData.principal.toLocaleString('zh-CN', {minimumFractionDigits: ((growthLatestData.coin || 'USDT') === 'BTC' || (growthLatestData.coin || 'USDT') === 'ETH') ? 4 : 2, maximumFractionDigits: ((growthLatestData.coin || 'USDT') === 'BTC' || (growthLatestData.coin || 'USDT') === 'ETH') ? 4 : 2}) : '0.00')}</td>
                                <td>${isGrowthRedeemed ? '0.00' : (growthLatestData ? growthLatestData.net_nav.toLocaleString('zh-CN', {minimumFractionDigits: ((growthLatestData.coin || 'USDT') === 'BTC' || (growthLatestData.coin || 'USDT') === 'ETH') ? 4 : 2, maximumFractionDigits: ((growthLatestData.coin || 'USDT') === 'BTC' || (growthLatestData.coin || 'USDT') === 'ETH') ? 4 : 2}) : '0.00')}</td>
                                <td>${growthStats.returnRate ? growthStats.returnRate + '%' : '0.00%'}</td>
                                <td>${growthStats.holdingDays}</td>
                                <td>${growthStats.annualizedReturn ? growthStats.annualizedReturn + '%' : '0.00%'}</td>
                                <td>${isGrowthRedeemed ? (growthLatestData ? formatDateToYMD(growthLatestData.date) : '-') : (growthAllLatestData ? formatDateToYMD(growthAllLatestData.date) : '-')}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            detailsDiv.innerHTML = detailsHtml;
        }
        
        // 辅助函数
        function getLatestData(data) {
            if (!data || data.length === 0) return null;
            return data.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }
        
        function calculateStats(data) {
            if (!data || data.length === 0) {
                return {
                    returnRate: '0.00',
                    holdingDays: 0,
                    annualizedReturn: '0.00'
                };
            }
            
            const latestData = data.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            const firstData = data.sort((a, b) => new Date(a.date) - new Date(b.date))[0];
            
            const holdingDays = Math.ceil(
                (new Date(latestData.date) - new Date(firstData.date)) / (1000 * 60 * 60 * 24)
            ) + 1;
            
            const returnRate = latestData.total_return !== undefined ? 
                (latestData.total_return * 100).toFixed(2) : '0.00';
            
            const annualizedReturn = calculateAnnualizedReturn(parseFloat(returnRate), holdingDays);
            
            return {
                returnRate,
                holdingDays,
                annualizedReturn
            };
        }
        
        function calculateAnnualizedReturn(returnRate, days) {
            if (!days || days <= 0) return '0.00';
            return ((Math.pow(1 + returnRate/100, 365/days) - 1) * 100).toFixed(2);
        }
        
        function formatDateToYMD(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function getDividendInfo(username) {
            const user = username && username.toLowerCase();
            if (["octopus", "sam", "jennifer", "alex"].includes(user)) {
                return '<span style="font-size:0.95em;color:#888;margin-left:8px;">（上次分红日期：2025-01-06）</span>';
            } else if (["bon", "ying", "tt"].includes(user)) {
                return '<span style="font-size:0.95em;color:#888;margin-left:8px;">（上次分红日期：2025-07-04）</span>';
            } else if (user === "hp") {
                return '<span style="font-size:0.95em;color:#888;margin-left:8px;">（上次分红日期：2025-12-18）</span>';
            } else if (user === "turbo") {
                return '<span style="font-size:0.95em;color:#888;margin-left:8px;">（上次分红日期：2025-12-12）</span>';
            }
            return '';
        }
        
        // 投资明细记录相关函数
        // fund名称映射
        const fundNameMapping = {
            'zerone': 'Alpha-Bridge',
            'HPU': 'Stable-Harbor-USDT',
            'arbitrage2': 'Stable-Harbor-USDT 2.0',
            'binggan': 'Stable-Harbor-BTC',
            'HPE': 'Stable-Harbor-ETH',
            // 兼容：用户 JSON 里可能用 growth 表示 Deep-Growth
            'growth': 'Deep-Growth',
            // 兼容：有些地方用 aggressive 作为 Deep-Growth 的 key
            'aggressive': 'Deep-Growth'
        };
        
        // 加载并显示投资明细记录
        function loadAndDisplayInvestmentDetails(username, userData) {
            if (!username || !userData) {
                return;
            }
            
            // 直接从用户JSON数据中读取投资明细记录
            displayInvestmentDetails(username, userData);
        }
        
        // 显示投资明细数据
        function displayInvestmentDetails(username, userData) {
            // 从用户JSON数据中获取投资明细记录
            if (!userData || !userData.investment_details) {
                const tbody = document.getElementById('investmentDetailTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无投资明细记录</td></tr>';
                }
                return;
            }
            
            const userRecords = userData.investment_details || [];
            
            // 先按产品名称排序，再按日期排序（从老到新）
            userRecords.sort((a, b) => {
                // 将日期格式从 "2024/6/11" 转换为 "2024/06/11" 以便正确解析
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return new Date(0);
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[0];
                        const month = parts[1].padStart(2, '0');
                        const day = parts[2].padStart(2, '0');
                        return new Date(`${year}-${month}-${day}`);
                    }
                    return new Date(dateStr);
                };
                
                // 获取产品名称（根据映射关系）
                // 兼容老数据：可能是 fund，也可能是 product
                const fundKeyA = a.fund || a.product || '';
                const fundKeyB = b.fund || b.product || '';
                const fundNameA = fundNameMapping[fundKeyA] || fundKeyA;
                const fundNameB = fundNameMapping[fundKeyB] || fundKeyB;
                
                // 先按产品名称排序
                const productCompare = fundNameA.localeCompare(fundNameB, 'zh-CN');
                if (productCompare !== 0) {
                    return productCompare;
                }
                
                // 如果产品名称相同，再按日期排序（从老到新）
                const dateA = normalizeDate(a.date);
                const dateB = normalizeDate(b.date);
                return dateA - dateB;
            });
            
            // 获取表格tbody元素
            const tbody = document.getElementById('investmentDetailTableBody');
            if (!tbody) {
                console.error('找不到投资明细表格tbody元素');
                return;
            }
            
            // 清空现有内容
            tbody.innerHTML = '';
            
            if (userRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无投资明细记录</td></tr>';
            } else {
                // 生成表格行
                userRecords.forEach(record => {
                    const row = document.createElement('tr');
                    
                // 产品名称：优先 fund，其次 product；并做映射（growth -> Deep-Growth）
                const rawFund = record.fund || record.product || '-';
                const fundName = fundNameMapping[rawFund] || rawFund;
                    
                    // 格式化日期为 yyyy-mm-dd 格式（只显示年月日，不显示时间）
                    let formattedDate = '-';
                    if (record.date) {
                        // 先去除时间部分（如果有T或空格，取前面的部分）
                        let dateOnly = record.date;
                        if (dateOnly.includes('T')) {
                            dateOnly = dateOnly.split('T')[0];
                        } else if (dateOnly.includes(' ')) {
                            dateOnly = dateOnly.split(' ')[0];
                        }
                        
                        // 处理 "年/月/日" 格式
                        const parts = dateOnly.split('/');
                        if (parts.length === 3) {
                            const year = parts[0];
                            const month = parts[1].padStart(2, '0');
                            const day = parts[2].padStart(2, '0');
                            formattedDate = `${year}-${month}-${day}`;
                        } else {
                            // 处理 "年-月-日" 格式（包括ISO格式 2024-11-13）
                            const dashParts = dateOnly.split('-');
                            if (dashParts.length >= 3) {
                                const year = dashParts[0];
                                const month = dashParts[1].padStart(2, '0');
                                const day = dashParts[2].padStart(2, '0');
                                formattedDate = `${year}-${month}-${day}`;
                            } else {
                                formattedDate = dateOnly;
                            }
                        }
                    }
                    
                    // 格式化金额和单位（从JSON中读取，已经是数字类型）
                    const amount = record.amount || 0;
                    const unit = record.unit || 0;
                    const unitTotal = record.unit_total || 0;
                    const coin = record.coin || '-';
                    
                    // 根据币种决定小数位数：BTC显示4位小数，其他币种显示2位小数
                    const decimals = coin === 'BTC' ? 4 : 2;
                    
                    // 格式化当日净值（4位小数）（从JSON中读取，已经是数字类型）
                    const navPerUnit = record.nav_per_unit;
                    const formattedNav = navPerUnit && navPerUnit !== 0 && !isNaN(navPerUnit) 
                        ? navPerUnit.toFixed(4) 
                        : '-';
                    
                    row.innerHTML = `
                        <td>${record.investor || '-'}</td>
                        <td>${formattedDate}</td>
                        <td>${fundName}</td>
                        <td>${record.action || '-'}</td>
                        <td>${coin}</td>
                        <td>${amount.toLocaleString('zh-CN', {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}</td>
                        <td>${unit.toLocaleString('zh-CN', {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}</td>
                        <td>${unitTotal.toLocaleString('zh-CN', {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}</td>
                        <td>${formattedNav}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        }
        
        // 密码修改处理功能已移除 - 现在通过手动更新用户数据文件实现
        
        // 文件列表功能已移除
        
        function showResult(message, type) {
            console.log('showResult 被调用:', message, type);
            const resultDiv = document.getElementById('result');
            console.log('resultDiv 元素:', resultDiv);
            
            if (resultDiv) {
                resultDiv.innerHTML = message;
                resultDiv.className = `result ${type}`;
                resultDiv.style.display = 'block';
                console.log('结果已显示');
            } else {
                console.error('找不到 result 元素');
            }
        }
        
        // 通过用户名匹配预设编码并生成邀请链接
        async function generateInviteLink() {
            console.log('generateInviteLink 被调用');
            
            const username = document.getElementById('inviteUsername').value;
            const inviteLinkInput = document.getElementById('inviteLink');
            const codeInfo = document.getElementById('codeInfo');
            const foundCodeInput = document.getElementById('foundCode');
            
            console.log('用户名:', username);
            
            if (!username) {
                showResult('请输入用户名', 'error');
                return;
            }
            
            try {
                // 动态查找用户对应的编码
                const userCodeResult = await window.codeManager.findUserCode(username);
                
                if (!userCodeResult.success) {
                    showResult(userCodeResult.error, 'error');
                    return;
                }
                
                const matchedCode = userCodeResult.code;
                
                // 检查是否有重复用户
                if (userCodeResult.duplicateUsers && userCodeResult.duplicateUsers.length > 0) {
                    const duplicateUser = userCodeResult.duplicateUsers.find(dup => 
                        dup.username.toLowerCase() === username.toLowerCase()
                    );
                    if (duplicateUser) {
                        showResult(`⚠️ 发现用户 "${username}" 有多个编码文件：${duplicateUser.codes.join(', ')}。将使用最新的编码。`, 'info');
                    }
                }
                
                console.log('匹配到的编码:', matchedCode);
                
                // 查询编码的到期日
                const expirationResult = await window.codeManager.getCodeExpiration(matchedCode);
                
                if (!expirationResult.success) {
                    showResult(`获取编码到期日失败：${expirationResult.error}`, 'error');
                    return;
                }
                
                // 生成邀请链接
                const inviteLink = `https://01capital.info/reset_pas.html?code=${matchedCode}`;
                
                // 显示结果
                inviteLinkInput.value = inviteLink;
                codeInfo.style.display = 'block';
                
                // 格式化到期日显示（包含完整的时分秒）
                const expiresAt = new Date(expirationResult.expiresAt);
                const formattedDateTime = expiresAt.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                if (expirationResult.isExpired) {
                    foundCodeInput.value = `编码已过期 (${matchedCode})`;
                    foundCodeInput.style.color = '#dc3545';
                    showResult(`邀请链接生成成功！用户：${username}`, 'success');
                } else {
                    foundCodeInput.value = `链接到期日：${formattedDateTime} (${matchedCode})`;
                    foundCodeInput.style.color = '#28a745';
                    showResult(`邀请链接生成成功！用户：${username}`, 'success');
                }
                
            } catch (error) {
                console.error('生成邀请链接失败:', error);
                showResult(`生成邀请链接失败：${error.message || '未知错误'}`, 'error');
            }
        }
        
        // 复制邀请链接
        function copyInviteLink() {
            const inviteLinkInput = document.getElementById('inviteLink');
            const copyButton = document.getElementById('copyInviteButton');
            
            if (!inviteLinkInput.value) {
                showResult('请先生成邀请链接', 'error');
                return;
            }
            
            inviteLinkInput.select();
            inviteLinkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                copyButton.textContent = '已复制';
                copyButton.classList.remove('btn-outline-secondary');
                copyButton.classList.add('btn-success');
                
                setTimeout(() => {
                    copyButton.textContent = '复制';
                    copyButton.classList.remove('btn-success');
                    copyButton.classList.add('btn-outline-secondary');
                }, 2000);
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(inviteLinkInput.value).then(() => {
                        copyButton.textContent = '已复制';
                        copyButton.classList.remove('btn-outline-secondary');
                        copyButton.classList.add('btn-success');
                        
                        setTimeout(() => {
                            copyButton.textContent = '复制';
                            copyButton.classList.remove('btn-success');
                            copyButton.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(() => {
                        showResult('复制失败，请手动复制', 'error');
                    });
                } else {
                    showResult('复制失败，请手动复制', 'error');
                }
            }
        }
        
        // 复制8位编码
        function copyCodeToClipboard() {
            const codeInput = document.getElementById('foundCode');
            const copyButton = document.getElementById('copyCodeButton');
            
            if (!codeInput.value) {
                showResult('请先生成邀请链接', 'error');
                return;
            }
            
            // 从显示文本中提取编码部分（括号内的内容）
            const codeMatch = codeInput.value.match(/\(([A-Z0-9]+)\)/);
            const codeToCopy = codeMatch ? codeMatch[1] : codeInput.value;
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        copyButton.textContent = '已复制';
                        copyButton.classList.remove('btn-outline-secondary');
                        copyButton.classList.add('btn-success');
                        
                        setTimeout(() => {
                            copyButton.textContent = '复制编码';
                            copyButton.classList.remove('btn-success');
                            copyButton.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(() => {
                        showResult('复制失败，请手动复制', 'error');
                    });
                } else {
                    // 降级方案
                    const textArea = document.createElement('textarea');
                    textArea.value = codeToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    copyButton.textContent = '已复制';
                    copyButton.classList.remove('btn-outline-secondary');
                    copyButton.classList.add('btn-success');
                    
                    setTimeout(() => {
                        copyButton.textContent = '复制编码';
                        copyButton.classList.remove('btn-success');
                        copyButton.classList.add('btn-outline-secondary');
                    }, 2000);
                }
            } catch (err) {
                showResult('复制失败，请手动复制', 'error');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            console.log('编码管理器状态:', window.codeManager ? '已加载' : '未加载');
            
            // 测试按钮点击
            const testButton = document.getElementById('generateInviteButton');
            console.log('测试按钮元素:', testButton);
            
            // 等待编码管理器加载
            setTimeout(() => {
                console.log('延迟检查编码管理器状态:', window.codeManager ? '已加载' : '未加载');
                if (window.codeManager) {
                    console.log('编码管理器加载成功');
                } else {
                    console.error('编码管理器加载失败');
                }
            }, 1000);
        });

        // 绑定事件
        document.getElementById('generateHashForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateHash();
        });
        
        document.getElementById('generateHashButton').addEventListener('click', generateHash);
        document.getElementById('copyHashButton').addEventListener('click', copyHashToClipboard);
        // 密码修改表单事件监听器已移除
        document.getElementById('previewUserData').addEventListener('click', previewUserData);
        document.getElementById('previewFullView').addEventListener('click', previewFullView);
        // 文件列表刷新事件监听器已移除
        
        // 绑定邀请链接生成按钮
        const generateInviteButton = document.getElementById('generateInviteButton');
        if (generateInviteButton) {
            console.log('绑定generateInviteButton事件');
            generateInviteButton.addEventListener('click', function(e) {
                console.log('generateInviteButton 被点击');
                e.preventDefault();
                generateInviteLink();
            });
        } else {
            console.error('找不到generateInviteButton元素');
        }
        
        document.getElementById('copyInviteButton').addEventListener('click', copyInviteLink);
        document.getElementById('copyCodeButton').addEventListener('click', copyCodeToClipboard);
        document.getElementById('reverseHashButton').addEventListener('click', recoverOriginalSecret);
        document.getElementById('copyRecoveredButton').addEventListener('click', copyRecoveredSecret);
    </script>
</body>
</html>
